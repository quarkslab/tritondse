

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tritondse.symbolic_executor &mdash; TritonDSE 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            TritonDSE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutos/starting.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutos/hooks.html">Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutos/seeds.html">Seeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutos/sanitizers.html">Sanitizers &amp; Probes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutos/loaders.html">Loaders</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/callbacks.html">Callback Mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/coverage.html">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/executor.html">SymbolicExecutor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/explorator.html">SymbolicExplorator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/exception.html">Exception</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/loaders.html">Loaders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/process.html">Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/sanitizers.html">Sanitizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/seeds.html">Seed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/tracing.html">Trace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/types.html">Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/workspace.html">Workspace</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Practicals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../practicals/toy_example/toy_example.html">Toy Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../practicals/json_parser/json_parser.html">JSON Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../practicals/crackme/crackme.html">Crackme</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev_doc/routines.html">Supported Routines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_doc/seedscheduling.html">Seed Scheduling</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TritonDSE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tritondse.symbolic_executor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tritondse.symbolic_executor</h1><div class="highlight"><pre>
<span></span><span class="c1"># built-in imports</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">resource</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">Type</span>

<span class="c1"># third party imports</span>
<span class="kn">from</span> <span class="nn">triton</span> <span class="kn">import</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">Instruction</span><span class="p">,</span> <span class="n">CPUSIZE</span><span class="p">,</span> <span class="n">MemoryAccess</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">tritondse.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">tritondse.coverage</span> <span class="kn">import</span> <span class="n">CoverageSingleRun</span><span class="p">,</span> <span class="n">BranchSolvingStrategy</span>
<span class="kn">from</span> <span class="nn">tritondse.process_state</span> <span class="kn">import</span> <span class="n">ProcessState</span>
<span class="kn">from</span> <span class="nn">tritondse.loaders.loader</span> <span class="kn">import</span> <span class="n">Loader</span>
<span class="kn">from</span> <span class="nn">tritondse.seed</span> <span class="kn">import</span> <span class="n">Seed</span><span class="p">,</span> <span class="n">SeedStatus</span><span class="p">,</span> <span class="n">CompositeData</span>
<span class="kn">from</span> <span class="nn">tritondse.types</span> <span class="kn">import</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">Architecture</span><span class="p">,</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Register</span>
<span class="kn">from</span> <span class="nn">tritondse.routines</span> <span class="kn">import</span> <span class="n">SUPPORTED_ROUTINES</span><span class="p">,</span> <span class="n">SUPORTED_GVARIABLES</span>
<span class="kn">from</span> <span class="nn">tritondse.callbacks</span> <span class="kn">import</span> <span class="n">CallbackManager</span>
<span class="kn">from</span> <span class="nn">tritondse.workspace</span> <span class="kn">import</span> <span class="n">Workspace</span>
<span class="kn">from</span> <span class="nn">tritondse.heap_allocator</span> <span class="kn">import</span> <span class="n">AllocatorException</span>
<span class="kn">from</span> <span class="nn">tritondse.thread_context</span> <span class="kn">import</span> <span class="n">ThreadContext</span>
<span class="kn">from</span> <span class="nn">tritondse.exception</span> <span class="kn">import</span> <span class="n">AbortExecutionException</span><span class="p">,</span> <span class="n">SkipInstructionException</span><span class="p">,</span> <span class="n">StopExplorationException</span><span class="p">,</span> <span class="n">ProbeException</span>
<span class="kn">from</span> <span class="nn">tritondse.memory</span> <span class="kn">import</span> <span class="n">MemoryAccessViolation</span><span class="p">,</span> <span class="n">Perm</span>
<span class="kn">import</span> <span class="nn">tritondse.logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">tritondse</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executor&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="SymbolicExecutor">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor">[docs]</a>
<span class="k">class</span> <span class="nc">SymbolicExecutor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single Program Execution Class.</span>
<span class="sd">    That module, is in charge of performing the process loading from the given</span>
<span class="sd">    program.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span> <span class="o">=</span> <span class="n">Seed</span><span class="p">(),</span> <span class="n">workspace</span><span class="p">:</span> <span class="n">Workspace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param config: configuration file to use</span>
<span class="sd">        :type config: Config</span>
<span class="sd">        :param seed: input file to inject either in stdin or argv (optional)</span>
<span class="sd">        :type seed: Seed</span>
<span class="sd">        :param workspace: Workspace to use. If None it will be instantiated</span>
<span class="sd">        :type workspace: Optional[Workspace]</span>
<span class="sd">        :param uid: Unique ID. Given by :py:obj:`SymbolicExplorator` to identify uniquely executions</span>
<span class="sd">        :type uid: int</span>
<span class="sd">        :param callbacks: callbacks to bind on this execution before running *(instanciated if empty !)*</span>
<span class="sd">        :type callbacks: CallbackManager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="n">config</span>      <span class="c1">#: Configuration file used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Loader</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: Loader used to run the code</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProcessState</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: ProcessState</span>

        <span class="c1"># Initialize the workspace</span>
        <span class="k">if</span> <span class="n">workspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">:</span> <span class="n">Workspace</span> <span class="o">=</span> <span class="n">workspace</span>  <span class="c1">#: exploration workspace</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">:</span> <span class="n">Workspace</span> <span class="o">=</span> <span class="n">Workspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>  <span class="c1">#: workspace object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">workspace_reset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span> <span class="o">=</span> <span class="n">seed</span>  <span class="c1">#: The current seed used for the execution</span>

        <span class="c1"># Override config if there is a mismatch between seed format and config file</span>
        <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">format</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed_format</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;seed format </span><span class="si">{</span><span class="n">seed</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2"> mismatch config </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">seed_format</span><span class="si">}</span><span class="s2"> (override config)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed_format</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">format</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_symbolic_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>     <span class="c1">#: symbolic seed (same structure than Seed but with symbols)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">:</span> <span class="n">CoverageSingleRun</span> <span class="o">=</span> <span class="n">CoverageSingleRun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">coverage_strategy</span><span class="p">)</span>  <span class="c1">#: Coverage of the execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rtn_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>   <span class="c1"># Addr -&gt; Tuple[fname, routine]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">uid</span>       <span class="c1">#: Unique identifier meant to unique accross Exploration instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#: start time of the process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1">#: end time of the process</span>

        <span class="c1"># create callback object if not provided as argument, and bind callbacks to the current process state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">callbacks</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">CallbackManager</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;callback manager&quot;&quot;&quot;</span>

        <span class="c1"># List of new seeds filled during the execution and flushed by explorator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_seeds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_to_target</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#: counter of instructions executed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#: previous program counter executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1">#: current program counter</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_pp</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_in_processing</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># use to know if we are currently processing an instruction</span>

        <span class="c1"># TODO: Here we load the binary each time we run an execution (via ELFLoader). We can</span>
        <span class="c1">#       avoid this (and so gain in speed) if a TritonContext could be forked from a</span>
        <span class="c1">#       state. See: https://github.com/JonathanSalwan/Triton/issues/532</span>

    <span class="k">def</span> <span class="nf">_init_symbolic_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">CompositeData</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">is_raw</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># is composite</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">argv</span><span class="p">]</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">CompositeData</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">argv</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">)</span>

<div class="viewcode-block" id="SymbolicExecutor.load">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">:</span> <span class="n">Loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the given loader to initialize the ProcessState.</span>
<span class="sd">        It overrides the current ProcessState if any.</span>

<span class="sd">        :param loader: Loader describing how to load</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize the process_state architecture (at this point arch is sure to be supported)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading program </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">architecture</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">from_loader</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_dynamic_symbols</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_seed_process_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></div>


<div class="viewcode-block" id="SymbolicExecutor.load_process">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.load_process">[docs]</a>
    <span class="k">def</span> <span class="nf">load_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pstate</span><span class="p">:</span> <span class="n">ProcessState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the given process state. Do nothing but</span>
<span class="sd">        setting the internal ProcessState.</span>

<span class="sd">        :param pstate: ProcessState to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span> <span class="o">=</span> <span class="n">pstate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_seed_process_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_seed_process_state</span><span class="p">(</span><span class="n">pstate</span><span class="p">:</span> <span class="n">ProcessState</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">is_raw</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># is composite</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">is_file_defined</span><span class="p">(</span><span class="s2">&quot;stdin&quot;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">get_file_input</span><span class="p">(</span><span class="s2">&quot;stdin&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="n">filedesc</span> <span class="o">=</span> <span class="n">pstate</span><span class="o">.</span><span class="n">get_file_descriptor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">filedesc</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">execution_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time taken for the execution in seconds</span>

<span class="sd">        .. warning:: Only relevant at the end of the execution</span>

<span class="sd">        :return: execution time (in s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pending_seeds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Seed</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of pending seeds gathered during execution.</span>

<span class="sd">        .. warning:: Only relevant at the end of execution</span>

<span class="sd">        :returns: list of new seeds generated</span>
<span class="sd">        :rtype: List[Seed]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_seeds</span>

<div class="viewcode-block" id="SymbolicExecutor.enqueue_seed">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.enqueue_seed">[docs]</a>
    <span class="k">def</span> <span class="nf">enqueue_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a seed to the queue of seed to be executed in later iterations.</span>
<span class="sd">        This function is meant to be used by user callbacks.</span>

<span class="sd">        :param seed: Seed to be added</span>
<span class="sd">        :type seed: Seed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">callback_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CallbackManager</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the callback manager associated with the execution.</span>

<span class="sd">        :rtype: CallbackManager&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span>

<div class="viewcode-block" id="SymbolicExecutor.is_seed_injected">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.is_seed_injected">[docs]</a>
    <span class="k">def</span> <span class="nf">is_seed_injected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get whether the seed has been injected.</span>

<span class="sd">        :return: True if the seed has already been inserted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_format_raw</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_format_composite</span><span class="p">():</span>
            <span class="c1"># Namely has one of the various input been injected or not</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="nf">_configure_pstate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># for mode in [MODE.ALIGNED_MEMORY, MODE.AST_OPTIMIZATIONS, MODE.CONSTANT_FOLDING, MODE.ONLY_ON_SYMBOLIZED]:</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MODE</span><span class="o">.</span><span class="n">ONLY_ON_SYMBOLIZED</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">set_triton_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;configure pstate: time_inc:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_inc_coefficient</span><span class="si">}</span><span class="s2">  solver:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">smt_solver</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">  timeout:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">smt_timeout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">time_inc_coefficient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_inc_coefficient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">set_solver_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">smt_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">smt_solver</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetch_next_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ThreadContext</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ThreadContext</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of threads, returns the next to execute. Iterating</span>
<span class="sd">        threads in a round-robin style picking the next item in the list.</span>

<span class="sd">        :param threads: list of threads</span>
<span class="sd">        :return: thread context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cur_idx</span> <span class="o">=</span> <span class="n">threads</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="p">)</span>

        <span class="n">tmp_list</span> <span class="o">=</span> <span class="n">threads</span><span class="p">[</span><span class="n">cur_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">threads</span><span class="p">[:</span><span class="n">cur_idx</span><span class="p">]</span>  <span class="c1"># rotate list (and exclude current_item)</span>
        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">tmp_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">th</span>  <span class="c1"># Return the first thread that is properly running</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__schedule_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threads_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">threads</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># If there is only one thread no need to schedule another thread</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thread_scheduling</span><span class="p">:</span>
            <span class="c1"># Select the next thread to execute</span>
            <span class="n">next_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_next_thread</span><span class="p">(</span><span class="n">threads_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">next_th</span><span class="p">:</span>  <span class="c1"># We found another thread to schedule</span>

                <span class="c1"># Call all callbacks related to threads</span>
                <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_context_switch_callback</span><span class="p">():</span>
                    <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="p">)</span>

                <span class="c1"># Save current context and restore new thread context (+kill current if dead)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">switch_thread</span><span class="p">(</span><span class="n">next_th</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># There are other thread but not other one is available (thus keep current one)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Reset its counter</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Increment the instruction counter of the thread (a bit in advance, but it does not matter)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_symbolic_mem_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="s1">&#39;SymbolicExecutor&#39;</span><span class="p">,</span> <span class="n">__</span><span class="p">:</span> <span class="n">ProcessState</span><span class="p">,</span> <span class="n">mem</span><span class="p">:</span> <span class="n">MemoryAccess</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">tgt_addr</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">getAddress</span><span class="p">()</span>
        <span class="n">lea_ast</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">getLeaAst</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lea_ast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">lea_ast</span><span class="o">.</span><span class="n">isSymbolized</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;read&quot;</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;symbolic </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> at 0x</span><span class="si">{</span><span class="n">pc</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">: target: 0x</span><span class="si">{</span><span class="n">tgt_addr</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">lea_ast</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">push_constraint</span><span class="p">(</span><span class="n">lea_ast</span> <span class="o">==</span> <span class="n">tgt_addr</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sym-</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_offset</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">pc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SymbolicExecutor.emulate">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.emulate">[docs]</a>
    <span class="k">def</span> <span class="nf">emulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">():</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">is_status_set</span><span class="p">():</span>  <span class="c1"># Set a status if it has not already been done</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SeedStatus</span><span class="o">.</span><span class="n">OK_DONE</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="SymbolicExecutor.step">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.step">[docs]</a>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a single instruction step. Returns whether the emulation can</span>
<span class="sd">        continue or we have to stop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Schedule thread if it&#39;s time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schedule_thread</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After scheduling current thread is not running (probably in a deadlock state)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Were not able to find a suitable thread thus exit emulation</span>

            <span class="c1"># Fetch program counter (of the thread selected), at this point the current thread should be running!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span>  <span class="c1"># should normally be already set but still.</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_to_target</span><span class="p">:</span>  <span class="c1"># Hit the location we wanted to reach</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PC=0, is it normal ? (stop)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">segmentation_enabled</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">has_ever_been_written</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span><span class="p">,</span> <span class="n">CPUSIZE</span><span class="o">.</span><span class="n">BYTE</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instruction not mapped: 0x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="n">instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">fetch_instruction</span><span class="p">()</span>
            <span class="n">opcode</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">()</span>
            <span class="n">mnemonic</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Trigger pre-address callback</span>
                <span class="n">pre_cbs</span><span class="p">,</span> <span class="n">post_cbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_address_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">pre_cbs</span><span class="p">:</span>
                    <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span><span class="p">)</span>

                <span class="c1"># Trigger pre-opcode callback</span>
                <span class="n">pre_opcode</span><span class="p">,</span> <span class="n">post_opcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_opcode_callbacks</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">pre_opcode</span><span class="p">:</span>
                    <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">opcode</span><span class="p">)</span>

                <span class="c1"># Trigger pre-mnemonic callback</span>
                <span class="n">pre_mnemonic</span><span class="p">,</span> <span class="n">post_mnemonic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_mnemonic_callbacks</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">pre_mnemonic</span><span class="p">:</span>
                    <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">)</span>

                <span class="c1"># Trigger pre-instruction callback</span>
                <span class="n">pre_insts</span><span class="p">,</span> <span class="n">post_insts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_instruction_callbacks</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">pre_insts</span><span class="p">:</span>
                    <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">instruction</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SkipInstructionException</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">is_syscall</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;execute syscall instruction </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">read_register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">_syscall_register</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Process</span>
            <span class="n">prev_pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_processing</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">process_instruction</span><span class="p">(</span><span class="n">instruction</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">is_halt_instruction</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hit </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span><span class="si">}</span><span class="s2"> instruction stop.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Instruction not supported: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instruction</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">skip_unsupported_instruction</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span> <span class="o">+=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>    <span class="c1"># try to jump over the instruction</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># stop emulation</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_in_processing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># increment trace offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_offset</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># update previous program counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span> <span class="o">=</span> <span class="n">prev_pc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span>  <span class="c1"># current_pc becomes new instruction pointer</span>

            <span class="c1"># Update the coverage of the execution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="o">.</span><span class="n">add_covered_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="p">)</span>

            <span class="c1"># Update coverage send it the last PathConstraint object if one was added</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">is_path_predicate_updated</span><span class="p">():</span>
                <span class="n">path_constraint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">last_branch_constraint</span>

                <span class="k">if</span> <span class="n">path_constraint</span><span class="o">.</span><span class="n">isMultipleBranches</span><span class="p">():</span>
                    <span class="n">branches</span> <span class="o">=</span> <span class="n">path_constraint</span><span class="o">.</span><span class="n">getBranchConstraints</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Branching condition has more than two branches&quot;</span><span class="p">)</span>
                    <span class="n">taken</span><span class="p">,</span> <span class="n">not_taken</span> <span class="o">=</span> <span class="n">branches</span> <span class="k">if</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;isTaken&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">branches</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">taken_addr</span><span class="p">,</span> <span class="n">not_taken_addr</span> <span class="o">=</span> <span class="n">taken</span><span class="p">[</span><span class="s1">&#39;dstAddr&#39;</span><span class="p">],</span> <span class="n">not_taken</span><span class="p">[</span><span class="s1">&#39;dstAddr&#39;</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_on_branch_covered_callback</span><span class="p">():</span>
                        <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="p">,</span> <span class="n">taken_addr</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="o">.</span><span class="n">add_covered_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="p">,</span> <span class="n">taken_addr</span><span class="p">,</span> <span class="n">not_taken_addr</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c1"># It is normally a dynamic jump or symbolic memory read/write</span>
                    <span class="n">cmt</span> <span class="o">=</span> <span class="n">path_constraint</span><span class="o">.</span><span class="n">getComment</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sym-read&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sym-write&quot;</span><span class="p">):</span>
                        <span class="k">pass</span>
                        <span class="c1"># NOTE: At the moment it does not seem suitable to count r/w pointers</span>
                        <span class="c1"># as part of the coverage. So does not have an influence on covered/not_covered.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New dynamic jump covered at: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">path_constraint</span><span class="o">.</span><span class="n">setComment</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dyn-jmp:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_offset</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="o">.</span><span class="n">add_covered_dynamic_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pc</span><span class="p">)</span>

            <span class="c1"># Trigger post-opcode callback</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">post_opcode</span><span class="p">:</span>
                <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">opcode</span><span class="p">)</span>

            <span class="c1"># Trigger post-mnemonic callback</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">post_mnemonic</span><span class="p">:</span>
                <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">)</span>

            <span class="c1"># Trigger post-instruction callback</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">post_insts</span><span class="p">:</span>
                <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">instruction</span><span class="p">)</span>

            <span class="c1"># Trigger post-address callbacks</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">post_cbs</span><span class="p">:</span>
                <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_pc</span><span class="p">)</span>

            <span class="c1"># Simulate routines</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_routines_handler</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AllocatorException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;An exception has been raised: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SeedStatus</span><span class="o">.</span><span class="n">CRASH</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Check timeout of the execution</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">execution_timeout</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">execution_timeout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Timeout of an execution reached&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SeedStatus</span><span class="o">.</span><span class="n">HANG</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">AbortExecutionException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">MemoryAccessViolation</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory violation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Call all the callbacks on the memory violations</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">get_memory_violation_callbacks</span><span class="p">():</span>
                <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># Assign the seed the status of crash</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">is_status_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SeedStatus</span><span class="o">.</span><span class="n">CRASH</span>

            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">ProbeException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Execution interrupted: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SeedStatus</span><span class="o">.</span><span class="n">FAIL</span>

            <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="nf">__handle_external_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Expression</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Symbolize or concretize return values of external functions &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ret_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">return_register</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>    <span class="c1"># Write its concrete value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">write_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># It should be a logic expression</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">write_symbolic_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;(routine </span><span class="si">{</span><span class="n">routine_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_routines_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">Instruction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function handle external routines calls. When the .plt jmp on an external</span>
<span class="sd">        address, we call the appropriate Python routine and set up the returned value</span>
<span class="sd">        which may be concrete or symbolic.</span>

<span class="sd">        :param instruction: The current instruction executed</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span>
        <span class="k">if</span> <span class="n">pc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtn_table</span><span class="p">:</span>
            <span class="n">routine_name</span><span class="p">,</span> <span class="n">routine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtn_table</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter external routine: </span><span class="si">{</span><span class="n">routine_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Trigger pre-address callback</span>
            <span class="n">pre_cbs</span><span class="p">,</span> <span class="n">post_cbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_imported_routine_callbacks</span><span class="p">(</span><span class="n">routine_name</span><span class="p">)</span>

            <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">pre_cbs</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">routine_name</span><span class="p">,</span> <span class="n">pc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if the callback return a value the function behavior will be skipped</span>
                    <span class="n">ret_val</span> <span class="o">=</span> <span class="n">ret</span>
                    <span class="k">break</span>  <span class="c1"># Set the ret val and break</span>

            <span class="k">if</span> <span class="n">ret_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If no ret_val has been set by any callback function call the supported routine</span>
                <span class="c1"># Emulate the routine and the return value</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="n">routine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_external_return</span><span class="p">(</span><span class="n">routine_name</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">)</span>

            <span class="c1"># Trigger post-address callbacks</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">post_cbs</span><span class="p">:</span>
                <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">routine_name</span><span class="p">,</span> <span class="n">pc</span><span class="p">)</span>

            <span class="c1"># Do not continue the execution if we are in a locked mutex</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">mutex_locked</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">mutex_locked</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">getAddress</span><span class="p">()</span>
                <span class="c1"># It&#39;s locked, so switch to another thread</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thread_scheduling</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">return</span>

            <span class="c1"># Do not continue the execution if we are in a locked semaphore</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">semaphore_locked</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">semaphore_locked</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">getAddress</span><span class="p">()</span>
                <span class="c1"># It&#39;s locked, so switch to another thread</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">current_thread</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thread_scheduling</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">architecture</span> <span class="o">==</span> <span class="n">Architecture</span><span class="o">.</span><span class="n">AARCH64</span><span class="p">:</span>
                <span class="c1"># Get the return address</span>
                <span class="n">ret_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">read_register</span><span class="p">(</span><span class="s1">&#39;x30&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">architecture</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Architecture</span><span class="o">.</span><span class="n">X86</span><span class="p">,</span> <span class="n">Architecture</span><span class="o">.</span><span class="n">X86_64</span><span class="p">]:</span>
                <span class="c1"># Get the return address and restore RSP (simulate RET)</span>
                <span class="n">ret_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">pop_stack_value</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Architecture not supported&quot;</span><span class="p">)</span>

            <span class="c1"># Hijack RIP to skip the call</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span> <span class="o">=</span> <span class="n">ret_addr</span>

    <span class="k">def</span> <span class="nf">_map_dynamic_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply dynamic relocations of imported functions and imported symbols</span>
<span class="sd">        regardless of the architecture or executable format</span>
<span class="sd">        .. FIXME: This function does not apply all possible relocations</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">default_stub</span><span class="p">(</span><span class="n">se</span><span class="p">:</span> <span class="s1">&#39;SymbolicExecutor&#39;</span><span class="p">,</span> <span class="n">pstate</span><span class="p">:</span> <span class="n">ProcessState</span><span class="p">):</span>
            <span class="n">rtn_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">rtn_table</span><span class="p">[</span><span class="n">pstate</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">program_counter</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calling </span><span class="si">{</span><span class="n">rtn_name</span><span class="si">}</span><span class="s2"> which is unsupported&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">se</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">skip_unsupported_import</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Like if function did nothing</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AbortExecutionException</span><span class="p">(</span><span class="s1">&#39;Execution aborted&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">is_func</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">dynamic_symbol_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">SUPPORTED_ROUTINES</span><span class="p">:</span>  <span class="c1"># if the routine name is supported</span>
                <span class="c1"># Add link to the routine and got tables</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rtn_table</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">SUPPORTED_ROUTINES</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">SUPORTED_GVARIABLES</span><span class="p">:</span>
                <span class="c1"># if self.pstate.architecture == Architecture.X86_64:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">SUPORTED_GVARIABLES</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>  <span class="c1"># write directly at addr</span>
                <span class="c1"># elif self.pstate.architecture == Architecture.AARCH64:</span>
                <span class="c1">#     val = self.pstate.memory.read_ptr(addr)</span>
                <span class="c1">#     self.pstate.memory.write_ptr(val, SUPORTED_GVARIABLES[symbol])</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># the symbol is not supported</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># print warning if first uid (so that it get printed once)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;symbol </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> imported but unsupported&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_func</span><span class="p">:</span>
                    <span class="c1"># Add link to a default stub function</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rtn_table</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">default_stub</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>    <span class="c1"># do nothing on unsupported symbols</span>

<div class="viewcode-block" id="SymbolicExecutor.abort">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.abort">[docs]</a>
    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abort the current execution. It works by raising</span>
<span class="sd">        an exception which is caught by the emulation function</span>
<span class="sd">        that takes care of returning appropriately afterward.</span>

<span class="sd">        :raise AbortExecutionException: to abort execution from anywhere</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">AbortExecutionException</span><span class="p">(</span><span class="s1">&#39;Execution aborted&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SymbolicExecutor.skip_instruction">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.skip_instruction">[docs]</a>
    <span class="k">def</span> <span class="nf">skip_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Skip the current instruction before it gets executed. It is only</span>
<span class="sd">        relevant to call it from pre-inst or pre-addr callbacks.</span>

<span class="sd">        :raise SkipInstructionException: to skip the current instruction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">SkipInstructionException</span><span class="p">(</span><span class="s2">&quot;Skip instruction&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SymbolicExecutor.stop_exploration">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.stop_exploration">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_exploration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to call to stop the whole exploration of</span>
<span class="sd">        the program. It raises an exception which is caught by SymbolicExplorator.</span>

<span class="sd">        :raise StopExplorationException: to stop the exploration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">StopExplorationException</span><span class="p">(</span><span class="s2">&quot;Stop exploration&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SymbolicExecutor.emulation_init">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.emulation_init">[docs]</a>
    <span class="k">def</span> <span class="nf">emulation_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ProcessState is None (have you called </span><span class="se">\&quot;</span><span class="s2">load</span><span class="se">\&quot;</span><span class="s2">?&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Configure memory segmentation using configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">set_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">memory_segmentation</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">memory_segmentation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">register_memory_read_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mem_accesses_callback</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">register_memory_write_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mem_accesses_callback</span><span class="p">)</span>

        <span class="c1"># Register memory callbacks in case we activated covering mem access</span>
        <span class="k">if</span> <span class="n">BranchSolvingStrategy</span><span class="o">.</span><span class="n">COVER_SYM_READ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">branch_solving_strategy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">register_memory_read_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbolic_mem_callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">BranchSolvingStrategy</span><span class="o">.</span><span class="n">COVER_SYM_WRITE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">branch_solving_strategy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">register_memory_write_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbolic_mem_callback</span><span class="p">)</span>

        <span class="c1"># bind dbm callbacks on the process state (newly initialized)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">bind_to</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># bind call</span>

        <span class="c1"># Let&#39;s emulate the binary from the entry point</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting emulation&#39;</span><span class="p">)</span>

        <span class="c1"># Get pre/post callbacks on execution</span>
        <span class="n">pre_cb</span><span class="p">,</span> <span class="n">post_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_execution_callbacks</span><span class="p">()</span>
        <span class="c1"># Iterate through all pre exec callbacks</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">pre_cb</span><span class="p">:</span>
            <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">)</span>

        <span class="c1"># Call it here to make sure in case of &quot;load_process&quot; the use has properly instantiated the architecture</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_pstate</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SymbolicExecutor.run">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop_at</span><span class="p">:</span> <span class="n">Addr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the program.</span>

<span class="sd">        If the :py:attr:`tritondse.Config.execution_timeout` is not set</span>
<span class="sd">        the execution might hang forever if the program does.</span>

<span class="sd">        :param stop_at: Address where to stop (if necessary)</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stop_at</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_to_target</span> <span class="o">=</span> <span class="n">stop_at</span>

        <span class="c1"># Call init steps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulation_init</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># Run until reaching a stopping condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulate</span><span class="p">()</span>

        <span class="c1"># Call termination steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulation_deinit</span><span class="p">()</span></div>


<div class="viewcode-block" id="SymbolicExecutor.emulation_deinit">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.emulation_deinit">[docs]</a>
    <span class="k">def</span> <span class="nf">emulation_deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">post_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_execution_callbacks</span><span class="p">()</span>
        <span class="c1"># Iterate through post exec callbacks</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">post_cb</span><span class="p">:</span>
            <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># IMPORTANT The next call is necessary otherwise there is a memory</span>
        <span class="c1">#           leak issues.</span>
        <span class="c1"># Unbind callbacks from the current symbolic executor instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>

        <span class="c1"># NOTE Unregister callbacks registered at the beginning of the function.</span>
        <span class="c1">#      This is necessary because we currently have a circular dependency</span>
        <span class="c1">#      between this class and the callback manager. Note that we create</span>
        <span class="c1">#      that circular dependency indirectly when we set the callback to</span>
        <span class="c1">#      a method of this class (_mem_accesses_callback and</span>
        <span class="c1">#      _symbolic_mem_callback).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">memory_segmentation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">unregister_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mem_accesses_callback</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">BranchSolvingStrategy</span><span class="o">.</span><span class="n">COVER_SYM_READ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">branch_solving_strategy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">unregister_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbolic_mem_callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">BranchSolvingStrategy</span><span class="o">.</span><span class="n">COVER_SYM_WRITE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">branch_solving_strategy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">unregister_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbolic_mem_callback</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emulation done [ret:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">read_register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">return_register</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">]  (time:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instructions executed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="o">.</span><span class="n">total_instruction_executed</span><span class="si">}</span><span class="s2">  symbolic branches: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">path_predicate_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory usage: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mem_usage_str</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_mem_accesses_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="s1">&#39;SymbolicExecutor&#39;</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ProcessState</span><span class="p">,</span> <span class="n">mem</span><span class="p">:</span> <span class="n">MemoryAccess</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is used to ensure memory accesses performed by side-effect of instructions</span>
<span class="sd">        semantic correctly checks memory segmentation. Thus, we only do the check during the processing</span>
<span class="sd">        of an instruction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ps</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">segmentation_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_processing</span><span class="p">:</span>
            <span class="n">perm</span> <span class="o">=</span> <span class="n">Perm</span><span class="o">.</span><span class="n">W</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">else</span> <span class="n">Perm</span><span class="o">.</span><span class="n">R</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">getAddress</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="n">mmap</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">get_map</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>  <span class="c1"># It raises</span>
            <span class="k">if</span> <span class="n">mmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MemoryAccessViolation</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">memory_not_mapped</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">perm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mmap</span><span class="o">.</span><span class="n">perm</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MemoryAccessViolation</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">map_perm</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">perm</span><span class="p">,</span> <span class="n">perm_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exitcode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Exit code value of the process. The value</span>
<span class="sd">        is simply the concrete value of the register</span>
<span class="sd">        marked as return_register (rax, on x86, r0 on ARM..)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">read_register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">return_register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>

<div class="viewcode-block" id="SymbolicExecutor.mem_usage_str">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.mem_usage_str">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mem_usage_str</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Debug function to track memory consumption of an execution (not</span>
<span class="sd">        implemented on Windows).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span><span class="p">:</span>
            <span class="n">size</span><span class="p">,</span> <span class="n">resident</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/proc/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">/statm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
            <span class="n">resident</span> <span class="o">=</span> <span class="n">resident</span> <span class="o">*</span> <span class="n">resource</span><span class="o">.</span><span class="n">getpagesize</span><span class="p">()</span>
            <span class="n">units</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;Kb&quot;</span><span class="p">),</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;Mb&quot;</span><span class="p">),</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;Gb&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">unit</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">units</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">resident</span> <span class="o">/</span> <span class="n">unit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># We are on the right unit</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.2f%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resident</span><span class="o">/</span><span class="n">unit</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">B&quot;</span> <span class="o">%</span> <span class="n">resident</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span></div>


<div class="viewcode-block" id="SymbolicExecutor.mk_new_seed_from_model">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.mk_new_seed_from_model">[docs]</a>
    <span class="k">def</span> <span class="nf">mk_new_seed_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Seed</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new seed from the given SMT model.</span>

<span class="sd">        :param model: SMT model</span>
<span class="sd">        :return: new seed object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">repl_bytearray</span><span class="p">(</span><span class="n">concrete</span><span class="p">,</span> <span class="n">symbolic</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbolic</span><span class="p">):</span>   <span class="c1"># Enumerate symvars associated with each byte</span>
                <span class="k">if</span> <span class="n">sv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sv</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>     <span class="c1"># If solver provided a new value for the symvar</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">getId</span><span class="p">()]</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
                        <span class="n">concrete</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>     <span class="c1"># Replace it in the bytearray</span>
            <span class="k">return</span> <span class="n">concrete</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_format_raw</span><span class="p">():</span>     <span class="c1"># RAW seed. =&gt; symbolize_stdin</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">repl_bytearray</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_format_composite</span><span class="p">():</span>
            <span class="c1"># NOTE will have to update this if more things are added to CompositeData</span>

            <span class="c1"># Handle argv (its meant to be here)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">argv</span><span class="p">]</span>
            <span class="n">new_argv</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="n">repl_bytearray</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">argv</span><span class="p">)]</span>

            <span class="c1"># Handle stdin and files</span>
            <span class="c1"># If the seed provides the content of files (#NOTE stdin is treated as a file)</span>
            <span class="n">new_files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                    <span class="n">new_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">repl_bytearray</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>  <span class="c1"># keep the current value in the seed</span>

            <span class="c1"># Handle variables, if the seed provides some</span>
            <span class="n">new_variables</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="n">conc</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="n">repl_bytearray</span><span class="p">(</span><span class="n">conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">new_variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">new_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># new variables are either bytes or int</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>  <span class="c1"># If it has not been injected keep the current concrete value</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">CompositeData</span><span class="p">(</span><span class="n">new_argv</span><span class="p">,</span> <span class="n">new_files</span><span class="p">,</span> <span class="n">new_variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="c1"># Calling callback if user defined one</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="n">Seed</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="o">.</span><span class="n">get_new_input_callback</span><span class="p">():</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="p">,</span> <span class="n">new_seed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="c1"># if the callback return a new input continue with that one</span>
                <span class="n">new_seed</span> <span class="o">=</span> <span class="n">cont</span>
        <span class="c1"># Return the</span>
        <span class="k">return</span> <span class="n">new_seed</span></div>


<div class="viewcode-block" id="SymbolicExecutor.inject_symbolic_argv_memory">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.inject_symbolic_argv_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">inject_symbolic_argv_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject the ith item of argv in memory.</span>
<span class="sd">        To be used only with composite seeds and only if seed have a symbolic argv</span>

<span class="sd">        :param addr: address where to inject the argv[ith]</span>
<span class="sd">        :param index: ith argv item</span>
<span class="sd">        :param value: value of the item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Write concrete bytes in memory</span>
        <span class="n">sym_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">symbolize_memory_bytes</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;argv[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>   <span class="c1"># Symbolize bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym_vars</span>   <span class="c1"># Add symbolic variables to symbolic seed</span></div>


<div class="viewcode-block" id="SymbolicExecutor.inject_symbolic_file_memory">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.inject_symbolic_file_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">inject_symbolic_file_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject a symbolic file (or part of it) in memory.</span>

<span class="sd">        :param addr: address where to inject the file bytes</span>
<span class="sd">        :param name: name of the file in the composite seed</span>
<span class="sd">        :param value: bytes content of the file</span>
<span class="sd">        :param offset: offset within the file (for partial file injection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Write concrete bytes in memory</span>
        <span class="n">sym_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">symbolize_memory_bytes</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>   <span class="c1"># Symbolize bytes</span>
        <span class="n">sym_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">is_composite</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span>
        <span class="n">sym_seed</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sym_vars</span>   <span class="c1"># Add symbolic variables to symbolic seed</span></div>

        <span class="c1"># FIXME: Handle if reading twice same input bytes !</span>

<div class="viewcode-block" id="SymbolicExecutor.inject_symbolic_variable_memory">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.inject_symbolic_variable_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">inject_symbolic_variable_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject a symbolic variable in memory.</span>

<span class="sd">        :param addr: address where to inject the variable</span>
<span class="sd">        :param name: name of the variable in the composite seed</span>
<span class="sd">        :param value: value of the variable</span>
<span class="sd">        :param offset: offset within the variable (for partial variable injection)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Write concrete bytes in memory</span>
        <span class="n">sym_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">symbolize_memory_bytes</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>  <span class="c1"># Symbolize bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym_vars</span>   <span class="c1"># Add symbolic variables to symbolic seed</span></div>

        <span class="c1"># FIXME: Handle if reading twice same input bytes !</span>

<div class="viewcode-block" id="SymbolicExecutor.inject_symbolic_file_register">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.inject_symbolic_file_register">[docs]</a>
    <span class="k">def</span> <span class="nf">inject_symbolic_file_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Register</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject a symbolic file (or part of it) into a register.</span>
<span class="sd">        The value has to be an integer.</span>
<span class="sd">        The caller has add constraints to the associated symbolic</span>
<span class="sd">        expression so when a model is obtained the resulting value fits</span>
<span class="sd">        in a byte.</span>

<span class="sd">        :param reg: register identifier</span>
<span class="sd">        :param name: name of the file in the composite seed</span>
<span class="sd">        :param value: integer value</span>
<span class="sd">        :param offset: offset within the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">tt_ctx</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">write_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Write concrete value in register</span>
        <span class="n">sym_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">symbolize_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>  <span class="c1"># Symbolize bytes</span>
        <span class="n">sym_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">is_composite</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span>
        <span class="n">sym_seed</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym_vars</span>  <span class="c1"># Add symbolic variables to symbolic seed</span></div>


<div class="viewcode-block" id="SymbolicExecutor.inject_symbolic_variable_register">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.inject_symbolic_variable_register">[docs]</a>
    <span class="k">def</span> <span class="nf">inject_symbolic_variable_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Register</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject a symbolic variable (or part of it) in a register.</span>
<span class="sd">        The value has to be an integer.</span>

<span class="sd">        :param reg: register identifier</span>
<span class="sd">        :param name: name of the variable</span>
<span class="sd">        :param value: integer value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">is_composite</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;cannot use inject_symbolic_variable_register on raw seeds!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">write_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>                         <span class="c1"># write concrete value in register</span>
            <span class="n">sym_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstate</span><span class="o">.</span><span class="n">symbolize_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>  <span class="c1"># symbolize value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_seed</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym_var</span>               <span class="c1"># add the symbolic variables to symbolic seed</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># meant to be bytes</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;variable injected in registers have to be integer values&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SymbolicExecutor.inject_symbolic_raw_input">
<a class="viewcode-back" href="../../api/executor.html#tritondse.SymbolicExecutor.inject_symbolic_raw_input">[docs]</a>
    <span class="k">def</span> <span class="nf">inject_symbolic_raw_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject the input in memory. This injection method should</span>
<span class="sd">        be used for RAW seed type.</span>

<span class="sd">        :param addr: address where to inject input.</span>
<span class="sd">        :param data: content of the seed</span>
<span class="sd">        :param offset: offset within the content of the seed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">is_composite</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;inject_symbolic_memory must not be used with composite seeds !&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inject_symbolic_file_memory</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Quarkslab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>